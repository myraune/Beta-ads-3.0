generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  agency
  brand
  streamer
  viewer
}

enum CampaignStatus {
  draft
  submitted
  approved
  rejected
  active
  paused
  completed
}

enum CreativeFormat {
  image
  gif
  mp4
}

enum ApprovalStatus {
  draft
  submitted
  approved
  rejected
}

enum SessionStatus {
  active
  disconnected
  ended
}

enum EventType {
  overlay_connected
  overlay_heartbeat
  overlay_disconnected
  session_started
  session_ended
  ad_candidate_selected
  ad_command_sent
  ad_rendered
  ad_completed
  ad_click
  ad_error
}

enum PayoutRateType {
  cpm
  fixed
}

enum PayoutStatus {
  pending
  paid
}

model User {
  id              String           @id @default(uuid())
  email           String           @unique
  role            Role             @default(streamer)
  passwordHash    String?
  emailVerifiedAt DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  streamerProfile StreamerProfile?
  magicLinks      MagicLinkToken[]
  auditLogs       AuditLog[]
}

model MagicLinkToken {
  id         String    @id @default(uuid())
  userId     String
  tokenHash  String    @unique
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model StreamerProfile {
  id          String              @id @default(uuid())
  userId      String              @unique
  displayName String?
  twitchHandle String?
  country     String?
  language    String?
  categories  String[]            @default([])
  avgViewers  Int?
  pricingTier String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  channels    Channel[]
  sessions    StreamSession[]
  events      Event[]

  @@index([twitchHandle])
}

model Channel {
  id               String               @id @default(uuid())
  streamerProfileId String
  twitchChannelName String
  country          String
  language         String
  categories       String[]             @default([])
  avgViewers       Int
  pricingTier      String
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  streamerProfile  StreamerProfile      @relation(fields: [streamerProfileId], references: [id], onDelete: Cascade)
  overlayCredential OverlayCredential?
  sessions         StreamSession[]
  assignments      CampaignAssignment[]
  payouts          Payout[]
  events           Event[]
  metrics          DailyMetric[]

  @@index([streamerProfileId])
}

model OverlayCredential {
  id        String   @id @default(uuid())
  channelId String   @unique
  keyHash   String
  keyPrefix String
  createdAt DateTime @default(now())
  rotatedAt DateTime @default(now())
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
}

model StreamSession {
  id               String         @id @default(uuid())
  streamerProfileId String
  channelId        String
  startedAt        DateTime       @default(now())
  endedAt          DateTime?
  lastHeartbeatAt  DateTime       @default(now())
  status           SessionStatus  @default(active)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  streamerProfile  StreamerProfile @relation(fields: [streamerProfileId], references: [id], onDelete: Cascade)
  channel          Channel        @relation(fields: [channelId], references: [id], onDelete: Cascade)
  events           Event[]

  @@index([channelId, startedAt])
  @@index([lastHeartbeatAt])
}

model Campaign {
  id         String               @id @default(uuid())
  name       String
  advertiser String
  objective  String
  startDate  DateTime
  endDate    DateTime
  budget     Decimal              @db.Decimal(14, 2)
  currency   String
  status     CampaignStatus       @default(draft)
  targeting  Json
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
  flights    Flight[]
  creatives  Creative[]
  assignments CampaignAssignment[]
  payouts    Payout[]
  events     Event[]
  metrics    DailyMetric[]

  @@index([status, startDate, endDate])
}

model Flight {
  id                   String           @id @default(uuid())
  campaignId           String
  pacingPerHour        Int
  capPerStreamerPerHour Int
  capPerSession        Int
  allowedFormats       CreativeFormat[]
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  campaign             Campaign         @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
}

model Creative {
  id             String         @id @default(uuid())
  campaignId     String
  format         CreativeFormat
  durationSec    Int
  clickUrl       String
  fallbackUrl    String?
  objectKey      String
  mimeType       String
  sizeBytes      Int
  approvalStatus ApprovalStatus @default(draft)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  campaign       Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  events         Event[]

  @@index([campaignId, approvalStatus])
}

model CampaignAssignment {
  id         String    @id @default(uuid())
  campaignId String
  channelId  String
  cpmRate    Decimal?  @db.Decimal(10, 4)
  fixedFee   Decimal?  @db.Decimal(12, 2)
  createdAt  DateTime  @default(now())
  campaign   Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  channel    Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([campaignId, channelId])
  @@index([channelId])
}

model Event {
  id         String       @id @default(uuid())
  type       EventType
  ts         DateTime
  requestId  String
  streamerId String?
  channelId  String?
  sessionId  String?
  campaignId String?
  creativeId String?
  payload    Json
  ip         String?      @db.Inet
  userAgent  String?
  createdAt  DateTime     @default(now())
  streamer   StreamerProfile? @relation(fields: [streamerId], references: [id], onDelete: SetNull)
  channel    Channel?     @relation(fields: [channelId], references: [id], onDelete: SetNull)
  session    StreamSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  campaign   Campaign?    @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  creative   Creative?    @relation(fields: [creativeId], references: [id], onDelete: SetNull)

  @@index([type, ts])
  @@index([campaignId, ts])
  @@index([channelId, ts])
  @@index([sessionId, ts])
}

model DailyMetric {
  id             String   @id @default(uuid())
  day            DateTime
  campaignId     String
  channelId      String
  impressions    Int      @default(0)
  clicks         Int      @default(0)
  minutesOnScreen Decimal @default(0) @db.Decimal(12, 4)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  campaign       Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  channel        Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([day, campaignId, channelId])
  @@index([campaignId, day])
}

model Payout {
  id                  String         @id @default(uuid())
  campaignId          String
  channelId           String
  rateType            PayoutRateType
  rate                Decimal        @db.Decimal(12, 4)
  deliveredImpressions Int
  amount              Decimal        @db.Decimal(12, 2)
  status              PayoutStatus   @default(pending)
  createdAt           DateTime       @default(now())
  paidAt              DateTime?
  campaign            Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  channel             Channel        @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([campaignId, channelId])
  @@index([campaignId, status])
}

model AuditLog {
  id          String   @id @default(uuid())
  actorUserId String?
  action      String
  entityType  String
  entityId    String
  payload     Json?
  createdAt   DateTime @default(now())
  actor       User?    @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId, createdAt])
}
